{% extends "base_generic_form.html" %}
{% load i18n %}
{% load l10n %}
{% load static %}


{% block extrahead %}
<link rel='stylesheet' href='{% static "bow/fullcalendar/dist/core/main.css"%}' />
<script src='{% static "bow/fullcalendar/dist/core/main.js"%}'></script>
<script src='{% static "bow/fullcalendar/dist/core/locales-all.js"%}'></script>
<script src='{% static "bow/fullcalendar/dist/daygrid/main.js"%}'></script>
<script src='{% static "bow/fullcalendar/dist/list/main.js"%}'></script>
<script src='{% static "bow/fullcalendar/dist/interaction/main.js"%}'></script>
{{ block.super }}
{% endblock %}
{% block form %}
<p>
    {% if not campaign.active %}
    {% blocktrans %}
    V průběhu soutěže
    {% endblocktrans %}
    {% if campaign.competition_phase.date_from %}{% trans "od" %} {{ campaign.competition_phase.date_from }}{% endif %}
    {% if campaign.competition_phase.date_to %}{% trans "do" %} {{ campaign.competition_phase.date_to }}{% endif %}{% blocktrans %}
    budeme zapsané jízdy bedlivě sledovat a vypočítávat osobní jezdeckou pravidelnost, která Vás dovede k vítězství.
    {% endblocktrans %}
</p><p>
    {% blocktrans %}
    Ještě před začátkem soutěže si můžete v kalendáři poznačit plánovanou dovolenou. Tímto způsobem se například výlety do Chorvatska negativně neodrazí na celkovém skóre.
    {% endblocktrans %}
</p>
{% else %}
<h3>Nejdřív vyberte mod dopravy a trasu, pak kliknete na datum a směr.</h3>
<div class ="card">
    <nav>
        <div class="nav nav-tabs" id="nav-tab" role="tablist">
            {% for cm in commute_modes %}
            <a class="nav-item nav-link {% if cm.eco and cm.does_count %}green-background{% elif cm.does_count %}grey-background {% endif %}" id="nav-{{cm.slug}}-tab" data-toggle="tab" role="tab" aria-controls="nav-{{cm.slug}}" href="#nav-{{cm.slug}}">
                {{cm.button_html | safe }}
            </a>
            {% endfor %}
        </div>
    </nav>
    <div class="tab-content" id="nav-tabContent">
        {% for cm in commute_modes %}
        <div class="tab-pane show" id="nav-{{cm.slug}}" role="tabpanel">
            <br/>
            {{cm.tooltip}}
            {% if cm.does_count and cm.eco %}
            <br/>
            <br/>
            <div class="input-group">
                <select type="text" class="form-control" id="route_select_{{cm.slug}}" onchange="on_route_select_{{cm.slug}}()"/>
                <input type="number" style="text-align: right;" max="1000" id="km_{{cm.slug}}"/>
                <div class="input-group-append">
                    <span class="input-group-text">Km</span>
                </div>
            </div>
            {% endif %}
        </div>
        {% endfor %}
    </div>
</div>
{% endif %}
<br/>
{% get_current_language as LANGUAGE_CODE %}
<div id='calendar'></div>
<script>
 var day_types = {
     "possible-vacation-day": {{possible_vacation_days|safe}},
     "active-day": {{active_days|safe}},
     "locked-day": {{locked_days|safe}},
     "non-working-day": {{non_working_days|safe}},
 };
 var possible_vacation_days = day_types["possible-vacation-day"];
 var vacation_id = {{first_vid}};
 var full_calendar;
 {% for cm in commute_modes %}
 {% if cm.does_count and cm.eco %}
 var route_options_{{cm.slug}} = {
     "{% trans "Zadat Km ručně" %}": function () {
         $("#km_{{cm.slug}}").val(0);
     },
     "{% trans "Nahrat GPX soubor" %}": function () {
         console.log("TODO");
     },
     "{% trans "Nakreslit trasu do mapy" %}": function () {
         console.log("TODO");
     },
     {% for trip in trips %}
     {% if trip.commute_mode == cm %}
     "{% trans "Stejně jako" %} {{trip.date}} {{trip.get_direction_display }} ({{trip.distance}} Km)": function () {
         $("#km_{{cm.slug}}").val({{trip.distance|stringformat:"f"}});
     },
     {% endif %}
     {% endfor %}
 };

 function on_route_select_{{cm.slug}}() {
     var sel = document.getElementById("route_select_{{cm.slug}}");
     route_options_{{cm.slug}}[sel.value]();
 }
 {% endif %}
 {% endfor %}



 function pad(n, width, z) {
     z = z || '0';
     n = n + '';
     return n.length >= width ? n : new Array(width - n.length + 1).join(z) + n;
 }

 function format_date(date){
     return date.getFullYear() + '-' + pad((date.getMonth() + 1).toString(), 2) + '-' + pad(date.getDate().toString(), 2);
 }


 function events_overlap(event1, event2) {
     if(event1.end && event2.end) {
         return ((event1.start >= event2.start && event1.start < event2.end) ||
                 (event1.end > event2.start && event1.end <= event2.end));
     } else {
         return false;
     }
 }

 function add_vacation(startDate, endDate) {
     startDateString = format_date(startDate);
     endDateString = format_date(endDate);
     if(possible_vacation_days.indexOf(startDateString) >= 0 && possible_vacation_days.indexOf(endDateString) >= 0){
         new_event = {
             title: "{% trans "Dovolená" %}",
             start: startDate,
             end: endDate,
             allDay: true,
             vacation_id: vacation_id++,
         }
         events = full_calendar.getEvents();
         for (eid in events) {
             if (events[eid]._def.extendedProps.vacation_id) {
                 if (events_overlap(new_event, events[eid])) {
                     e2 = events[eid]
                     return;
                 }
             }
         }
         full_calendar.addEvent(new_event);
         $.post('{% url "calendar" %}', {
             on_vacation: true,
             start_date: startDateString,
             end_date: endDateString,
             csrfmiddlewaretoken: "{{ csrf_token }}",
         },
                function(returnedData){
                }
         ).fail(function(jqXHR, textStatus, errorThrown) {
             window.alert('{% trans "Propojení selhalo" %}');
         });
     }
 }

 function remove_vacation(info) {
     var event = info.event;
     startDateString = format_date(event.start)
     endDateString = format_date(event.end)
     event.remove() //todo remove
     $.post("{% url 'calendar' %}", {
         on_vacation: false,
         start_date: startDateString,
         end_date: endDateString,
         csrfmiddlewaretoken: "{{ csrf_token }}",
     },
            function(returnedData){
                event.remove()
            }
     ).fail(function(jqXHR, textStatus, errorThrown) {
         window.alert('{% trans "Propojení selhalo" %}');
     });
 }

 document.addEventListener('DOMContentLoaded', function() {
     {% for cm in commute_modes %}
     {% if cm.does_count and cm.eco %}
     var sel = document.getElementById("route_select_{{cm.slug}}");
     for(var key in route_options_{{cm.slug}}){
         var option = document.createElement("option");
         option.value = key;
         option.text = key;
         sel.appendChild(option);
     }
     {% endif %}
     {% endfor %}

     var calendarEl = document.getElementById('calendar');

     full_calendar = new FullCalendar.Calendar(calendarEl, {
         events: {{events|safe}},
         eventOrder: 'order',
         selectable: true,
         lang: '{{ LANGUAGE_CODE }}',
         locale: '{{ LANGUAGE_CODE }}',
         height: 'auto',
         firstDay: 1,
         plugins: [ 'interaction', 'dayGrid', 'list' ],
         selectable: true,
         header: {
             right: 'dayGridMonth,listMonth, now, prev,next',
         },
         select: function(info) {
             console.log(info)
             add_vacation(info.start, info.end);
         },
         eventRender: function(info) {
             console.log(info);
             var direction_icon = null;
             exp = info.event._def.extendedProps
             if (exp.direction == 'trip_to'){
                 direction_icon = document.createElement("i");
                 direction_icon.className='fa fa-industry xs';
             } else if (exp.direction == 'trip_from') {
                 direction_icon = document.createElement("i");
                 direction_icon.className='fa fa-home xs';
             }
             if (direction_icon) {
                 info.el.firstChild.append(direction_icon);
             }
             var mode_icon = null;
             if (exp.commute_mode == 'bicycle'){
                 mode_icon = document.createElement("i");
                 mode_icon.className='fa fa-bicycle xs';
             } else if (exp.commute_mode == 'by_foot') {
                 mode_icon = document.createElement("i");
                 mode_icon.className='fa fa-running xs';
             }
             if (mode_icon) {
                 info.el.firstChild.prepend(mode_icon);
             }
             if (info.event._def.extendedProps.vacation_id) { // https://stackoverflow.com/questions/26530076/fullcalendar-js-deleting-event-on-button-click#26530819
                 var trash_icon =  document.createElement("i");
                 var trash_button = document.createElement("button");
                 trash_button.className = 'btn btn-default btn-xs';
                 trash_button.append(trash_icon);
                 var trash_button_div = document.createElement("div");
                 trash_button_div.className='fc-transparent trash-container';
                 trash_button_div.append(trash_button);
                 trash_button.onclick = function(){remove_vacation(info)};
                 trash_icon.className = 'fa fa-trash';
                 info.el.firstChild.append(trash_button_div);
             }
         },
         dayRender: function (cell) {
             var set = false;
             console.log(cell)
             for (key in day_types) {
                 if (day_types[key].indexOf(format_date(cell.date)) >= 0) {
                     cell.el.classList.add(key);
                     set = true;
                 }
             }
             if (!set){
                 cell.el.classList.add("out-of-competition-day");
             }
         },
     });
     full_calendar.render();
 });
</script>
{% endblock %}
